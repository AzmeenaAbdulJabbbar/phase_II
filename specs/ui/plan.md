# Implementation Plan: Phase II Frontend UI Core

**Branch**: `002-frontend-ui-core` | **Date**: 2025-12-23 | **Spec**: [specs/ui/frontend-core.md](frontend-core.md)

**Input**: User requirements: "Design the Next.js monorepo structure in /frontend:
1. Auth Setup: Better Auth client configuration with JWT.
2. API Client: Implementation of 'apiClient' in 'lib/api.ts' that injects the Bearer token.
3. Layout: Root layout with Tailwind styling and Navbar.
4. Pages: Sign-in, Sign-up, and the main Dashboard."

---

## Summary

This plan outlines the implementation of the Phase II Frontend UI Core - a responsive, multi-user Todo web interface built with Next.js 16+ App Router and Better Auth integration. The frontend communicates with the FastAPI backend via JWT-secured API calls, ensuring complete data isolation between users.

**Primary Objective**: Create a production-ready frontend monorepo structure in `/frontend` with authentication flows (sign-in, sign-up), a protected dashboard for task management, and a reusable API client that automatically injects Bearer tokens for backend authorization.

**Technical Approach**:
- Next.js 16+ App Router with TypeScript and Tailwind CSS
- Better Auth with JWT Plugin for authentication
- Custom API client with automatic Bearer token injection
- Optimistic UI updates for smooth user experience
- Responsive design (320px-1920px screen widths)

---

## Technical Context

**Language/Version**: TypeScript (strict mode), Node.js 20+ LTS
**Primary Dependencies**: Next.js 16+, React 18+, Better Auth, Tailwind CSS
**Storage**: Browser session/cookies for JWT tokens (httpOnly recommended)
**Testing**: Vitest for unit tests, Playwright for E2E (future)
**Target Platform**: Modern web browsers (Chrome, Firefox, Safari, Edge - last 2 versions)
**Project Type**: Web application (monorepo frontend component)
**Performance Goals**:
- Task list renders within 2 seconds (SC-003)
- Optimistic updates within 50ms (SC-009)
- Form validation feedback <100ms (SC-007)
- UI responsive during API calls (SC-006)

**Constraints**:
- Must maintain <200ms API response time assumption
- Maximum 1000 tasks per user for UI performance
- Network latency tolerance (retry logic, error handling)
- JWT token refresh before expiration (Constitution mandate)

**Scale/Scope**:
- Multi-user system (isolated data per user)
- 9 user stories (P1-P3 prioritization)
- 23 functional requirements (FR-001 to FR-023)
- 10 success criteria (SC-001 to SC-010)

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-checked after Phase 1 design.*

âœ… **I. Spec-Driven Development**:
- Spec created at `specs/ui/frontend-core.md`
- Planning follows `/sp.plan` workflow
- Tasks generation will follow `/sp.tasks`
- Implementation via `/sp.implement`

âœ… **II. Monorepo Architecture**:
- Frontend in `/frontend` directory
- Specs in `/specs/ui/`
- Layered CLAUDE.md for frontend-specific rules

âœ… **III. Technology Stack Compliance**:
- Next.js 16+ with App Router âœ“
- TypeScript strict mode âœ“
- Tailwind CSS âœ“
- Better Auth with JWT Plugin âœ“

âœ… **IV. Security & Identity Protocol**:
- Better Auth JWT Plugin enabled
- Bearer token injection on EVERY API request
- JWT Bridge pattern implemented (Authorization header)
- Backend JWT verification required
- Data isolation by user_id (enforced by backend)

âœ… **V. Database & API Patterns**:
- API client follows REST conventions
- Pydantic-compatible request/response types
- Consistent error handling
- All backend routes under `/api/` prefix

âœ… **VI. Spec-Kit Plus Workflow**:
- Spec in `/specs/ui/frontend-core.md`
- Plan in `/specs/ui/plan.md` (this file)
- Tasks will be in `/specs/ui/tasks.md` (next step)
- Implementation follows workflow sequence

**GATE RESULT**: âœ… PASS - All constitutional requirements satisfied

---

## Project Structure

### Documentation (this feature)

```text
specs/ui/
â”œâ”€â”€ frontend-core.md         # Feature specification (User input)
â”œâ”€â”€ plan.md                  # This file (/sp.plan output)
â”œâ”€â”€ plan/
â”‚   â”œâ”€â”€ research.md          # Phase 0: Technology decisions
â”‚   â”œâ”€â”€ data-model.md        # Phase 1: TypeScript type definitions
â”‚   â”œâ”€â”€ quickstart.md        # Phase 1: Setup instructions
â”‚   â””â”€â”€ contracts/           # Phase 1: API/Auth client contracts
â”‚       â”œâ”€â”€ api-client.ts
â”‚       â””â”€â”€ auth-client.ts
â”œâ”€â”€ checklists/              # Requirement checklists
â”‚   â””â”€â”€ requirements.md
â””â”€â”€ tasks.md                 # Phase 2: Generated by /sp.tasks (NOT created by /sp.plan)
```

### Source Code (repository root)

```text
frontend/                        # Next.js 16+ application
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # App Router pages
â”‚   â”‚   â”œâ”€â”€ (auth)/            # Route group: Auth pages (no navbar)
â”‚   â”‚   â”‚   â”œâ”€â”€ signin/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx   # Login page
â”‚   â”‚   â”‚   â”œâ”€â”€ signup/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx   # Registration page
â”‚   â”‚   â”‚   â””â”€â”€ layout.tsx     # Minimal auth layout
â”‚   â”‚   â”œâ”€â”€ (dashboard)/       # Route group: Protected routes (with navbar)
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx       # Main task list dashboard
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx     # Dashboard layout (Navbar + Sidebar)
â”‚   â”‚   â”‚   â””â”€â”€ loading.tsx    # Loading skeleton
â”‚   â”‚   â”œâ”€â”€ layout.tsx         # Root layout (Tailwind, providers)
â”‚   â”‚   â”œâ”€â”€ page.tsx           # Landing page (redirects)
â”‚   â”‚   â””â”€â”€ globals.css        # Tailwind imports
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/                # Reusable UI primitives
â”‚   â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Checkbox.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Modal.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Skeleton.tsx
â”‚   â”‚   â”‚   â””â”€â”€ Toast.tsx
â”‚   â”‚   â”œâ”€â”€ layout/            # Layout components
â”‚   â”‚   â”‚   â”œâ”€â”€ Navbar.tsx     # Top navigation with user info/logout
â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx    # Filter sidebar
â”‚   â”‚   â”‚   â””â”€â”€ MainContent.tsx
â”‚   â”‚   â”œâ”€â”€ tasks/             # Task-related components
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskList.tsx   # Task list container
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskCard.tsx   # Individual task display
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskForm.tsx   # Create/edit task form
â”‚   â”‚   â”‚   â”œâ”€â”€ TaskFilters.tsx # Filter controls (All/Active/Completed)
â”‚   â”‚   â”‚   â””â”€â”€ EmptyState.tsx # Empty state UI
â”‚   â”‚   â””â”€â”€ auth/              # Auth components
â”‚   â”‚       â”œâ”€â”€ LoginForm.tsx
â”‚   â”‚       â”œâ”€â”€ SignupForm.tsx
â”‚   â”‚       â””â”€â”€ LogoutButton.tsx
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ api.ts             # API client (Bearer token injection)
â”‚   â”‚   â”œâ”€â”€ auth.ts            # Better Auth server config
â”‚   â”‚   â””â”€â”€ auth-client.ts     # Better Auth client
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ task.ts            # Task, TaskCreate, TaskUpdate
â”‚   â”‚   â”œâ”€â”€ api.ts             # ApiResponse, ApiError
â”‚   â”‚   â”œâ”€â”€ auth.ts            # User, Session, AuthState
â”‚   â”‚   â”œâ”€â”€ ui.ts              # TaskFilter, LoadingState, ModalState
â”‚   â”‚   â””â”€â”€ forms.ts           # Form state types
â”‚   â””â”€â”€ middleware.ts          # Route protection middleware
â”œâ”€â”€ public/
â”œâ”€â”€ .env.example               # Environment template
â”œâ”€â”€ .env.local                 # Local environment (gitignored)
â”œâ”€â”€ tailwind.config.ts         # Tailwind configuration
â”œâ”€â”€ next.config.ts             # Next.js configuration
â”œâ”€â”€ tsconfig.json              # TypeScript configuration
â””â”€â”€ package.json               # Dependencies and scripts
```

**Structure Decision**: Web application (Option 2) with `/frontend` as the Next.js monorepo component. Route groups separate auth pages from protected dashboard pages. Feature-based component organization improves maintainability.

---

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No constitutional violations detected. All implementation decisions align with project principles.

---

## Phase 0: Research (Completed)

**Output**: `specs/ui/plan/research.md`

**Resolved Unknowns**:
1. âœ… Next.js 16+ App Router structure with route groups
2. âœ… Better Auth configuration with JWT Plugin
3. âœ… API client pattern with Bearer token injection
4. âœ… Tailwind CSS responsive design setup
5. âœ… Component architecture (feature-based)
6. âœ… State management strategy (useState + useOptimistic)
7. âœ… TypeScript type definitions for API contracts

**Key Decisions**:
- **Routing**: App Router with `(auth)` and `(dashboard)` route groups
- **Auth**: Better Auth with JWT Plugin, httpOnly cookies for tokens
- **API Client**: Custom fetch wrapper with automatic Bearer token injection
- **Styling**: Tailwind CSS utility-first approach
- **State**: React useState for local state, useOptimistic for optimistic updates
- **Types**: Shared TypeScript interfaces mirroring backend Pydantic models

---

## Phase 1: Design & Contracts (Completed)

**Output**:
- `specs/ui/plan/data-model.md` - TypeScript type definitions
- `specs/ui/plan/contracts/api-client.ts` - API client interface contract
- `specs/ui/plan/contracts/auth-client.ts` - Auth client interface contract
- `specs/ui/plan/quickstart.md` - Setup and development instructions

### Data Model Summary

**Core Entities**:
- `Task`: Frontend view of backend Task model (id, user_id, title, description, completed, timestamps)
- `TaskCreate`: Payload for creating tasks (title required, description optional)
- `TaskUpdate`: Payload for updating tasks (all fields optional)
- `OptimisticTask`: Task with pending/error metadata for optimistic updates

**Auth Types**:
- `User`: User information from Better Auth session
- `Session`: JWT token and expiration details
- `AuthState`: Combined auth state (user, session, isLoading, isAuthenticated)

**UI State Types**:
- `TaskFilter`: 'all' | 'active' | 'completed'
- `LoadingState`: Loading states for different operations
- `ModalState`: Modal type and context data

### API Contracts Summary

**IApiClient Interface**:
- HTTP methods: `get()`, `post()`, `put()`, `patch()`, `delete()`
- Automatic Bearer token injection via `Authorization` header
- Centralized error handling with `ApiError` class
- Type-safe responses with TypeScript generics

**ITaskApi Interface**:
- `list()`: Get all tasks for authenticated user
- `get(id)`: Get single task by ID
- `create(data)`: Create new task
- `update(id, data)`: Update existing task
- `delete(id)`: Delete task
- `toggleComplete(id, completed)`: Convenience method for completion toggle

**IAuthClient Interface** (Better Auth):
- `signIn(credentials)`: Email/password authentication
- `signUp(data)`: User registration
- `signOut()`: Terminate session
- `getSession()`: Get current session
- `isAuthenticated()`: Check auth status
- `refreshToken()`: Manual token refresh

### Quickstart Summary

**Setup Steps**:
1. Install Node.js 20+ and pnpm
2. Create `frontend/.env.local` with `NEXT_PUBLIC_API_URL` and `BETTER_AUTH_SECRET`
3. Install dependencies: `pnpm install`
4. Start dev server: `pnpm dev`

**Key Files**:
- `lib/auth.ts`: Better Auth server configuration
- `lib/auth-client.ts`: Better Auth client hooks
- `lib/api.ts`: API client implementation
- `middleware.ts`: Route protection logic

**Development Workflow**:
1. Start backend (port 8000)
2. Start frontend (port 3000)
3. Test auth flow: signup â†’ signin â†’ dashboard
4. Verify task CRUD operations

---

## Phase 2: Architecture Blueprint

### Component Hierarchy

```
App (Root Layout)
â”œâ”€â”€ Tailwind CSS Global Styles
â”œâ”€â”€ Better Auth Provider
â””â”€â”€ Route-Specific Layouts
    â”œâ”€â”€ (auth) Layout [Minimal]
    â”‚   â”œâ”€â”€ /signin â†’ LoginForm
    â”‚   â””â”€â”€ /signup â†’ SignupForm
    â””â”€â”€ (dashboard) Layout [Full]
        â”œâ”€â”€ Navbar (user info, logout)
        â”œâ”€â”€ Sidebar (filters)
        â””â”€â”€ MainContent
            â”œâ”€â”€ TaskList
            â”‚   â”œâ”€â”€ TaskCard (multiple)
            â”‚   â”œâ”€â”€ TaskForm (modal)
            â”‚   â””â”€â”€ EmptyState (conditional)
            â””â”€â”€ TaskFilters
```

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend Data Flow                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  User Action                                                  â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚  Component (e.g., TaskCard)                                   â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚  Optimistic Update (useOptimistic)                            â”‚
â”‚      â”‚                                                        â”‚
â”‚      â”œâ”€ UI updates immediately (pending state)                â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚  API Client (lib/api.ts)                                      â”‚
â”‚      â”‚                                                        â”‚
â”‚      â”œâ”€ Get session from Better Auth                          â”‚
â”‚      â”œâ”€ Inject Bearer token in Authorization header           â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚  Backend API (FastAPI)                                        â”‚
â”‚      â”‚                                                        â”‚
â”‚      â”œâ”€ Verify JWT                                            â”‚
â”‚      â”œâ”€ Extract user_id from token                            â”‚
â”‚      â”œâ”€ Filter data by user_id                                â”‚
â”‚      â”‚                                                        â”‚
â”‚      â–¼                                                        â”‚
â”‚  Response                                                     â”‚
â”‚      â”‚                                                        â”‚
â”‚      â”œâ”€ Success: Replace optimistic data with server data     â”‚
â”‚      â””â”€ Error: Rollback optimistic update, show error toast   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Authentication Flow

```
1. User visits /signin or /signup
   â”‚
   â–¼
2. LoginForm/SignupForm captures credentials
   â”‚
   â–¼
3. Call authClient.signIn() or authClient.signUp()
   â”‚
   â”œâ”€ Better Auth communicates with backend
   â”œâ”€ Backend verifies credentials
   â”œâ”€ Backend returns JWT token
   â”‚
   â–¼
4. Better Auth stores token (httpOnly cookie)
   â”‚
   â–¼
5. Middleware detects authenticated session
   â”‚
   â–¼
6. Redirect to /dashboard
   â”‚
   â–¼
7. All subsequent API calls include Bearer token
   â”‚
   â–¼
8. Backend extracts user_id from token
   â”‚
   â–¼
9. User sees only their own tasks
```

### Route Protection Strategy

**Middleware Logic** (`middleware.ts`):
- **Protected Routes** (`/dashboard/*`): Require valid session, else redirect to `/signin`
- **Auth Routes** (`/signin`, `/signup`): Redirect to `/dashboard` if already authenticated
- **Public Routes**: Allow access without authentication

**Client-Side Guards**:
- `useSession()` hook provides auth state to components
- Loading states while session is being verified
- Conditional rendering based on `isAuthenticated`

---

## Implementation Phases (for /sp.tasks)

### Phase A: Project Setup & Configuration
- Initialize Next.js 16+ project in `/frontend`
- Configure TypeScript (strict mode)
- Configure Tailwind CSS
- Set up Better Auth
- Create environment configuration

### Phase B: Type Definitions & Contracts
- Implement types in `src/types/`
- Create API client in `lib/api.ts`
- Create auth client in `lib/auth-client.ts`
- Set up middleware for route protection

### Phase C: UI Components (Primitives)
- Build reusable UI components (`ui/`)
- Button, Input, Card, Checkbox, Modal, Skeleton, Toast
- Tailwind styling with responsive design

### Phase D: Layout Components
- Root layout with Tailwind global styles
- Auth layout (minimal)
- Dashboard layout (Navbar + Sidebar + MainContent)
- Navbar with user info and logout
- Sidebar with filter controls

### Phase E: Authentication Pages
- Sign-in page (`/signin`)
- Sign-up page (`/signup`)
- Form validation and error handling
- Integration with Better Auth

### Phase F: Dashboard & Task Management
- Dashboard page (`/dashboard`)
- TaskList component with loading skeleton
- TaskCard component with actions (edit, delete, toggle complete)
- TaskForm modal for create/edit
- TaskFilters for All/Active/Completed
- EmptyState for no tasks

### Phase G: Optimistic Updates & Error Handling
- Implement useOptimistic for task operations
- Error toast notifications
- Retry logic for failed requests
- 401 handling (redirect to signin)

### Phase H: Testing & Polish
- Unit tests for components
- Integration tests for auth flow
- E2E tests for task CRUD
- Performance optimization (check SC-001 to SC-010)
- Accessibility audit

---

## Risk Analysis

| Risk | Impact | Mitigation |
|------|--------|------------|
| JWT token mismatch between frontend/backend | High - Auth breaks | Ensure `BETTER_AUTH_SECRET` is identical; document clearly |
| CORS issues | High - API calls fail | Backend must allow `http://localhost:3000` origin |
| Token expiration during use | Medium - User kicked out | Better Auth auto-refresh; handle 401 gracefully |
| Network failures during optimistic updates | Medium - UI out of sync | Rollback optimistic state; show error toast with retry |
| Slow API responses (>2s) | Medium - SC-003 violated | Loading skeletons; investigate backend performance |
| Large task lists (>1000) | Low - UI sluggish | Pagination or virtualization (future enhancement) |

---

## Success Criteria Validation

| Criterion | Implementation Strategy |
|-----------|------------------------|
| **SC-001**: Signup/login within 30s | Simple forms, minimal validation, fast auth flow |
| **SC-002**: Create task within 10s | One-click "Add Task" button, simple modal form |
| **SC-003**: Task list loads within 2s | Loading skeleton, fetch on mount, efficient rendering |
| **SC-004**: 95% operations succeed first try | Comprehensive error handling, validation, retry logic |
| **SC-005**: 100% unauthorized redirect | Middleware enforces auth on all `/dashboard/*` routes |
| **SC-006**: UI responsive during API calls | Non-blocking async calls, loading indicators |
| **SC-007**: Form validation <100ms | Client-side validation, native HTML5 validation |
| **SC-008**: Responsive 320px-1920px | Tailwind responsive utilities, mobile-first design |
| **SC-009**: Optimistic updates <50ms | useOptimistic hook, local state updates before API call |
| **SC-010**: Error states within 3s | Immediate error toast on failure |

---

## Next Steps

1. **Run `/sp.tasks`**: Generate atomic task list from this plan
2. **Review tasks.md**: Ensure all implementation steps are captured
3. **Run `/sp.implement`**: Execute tasks sequentially
4. **Run `/sp.git.commit_pr`**: Commit changes and create PR

---

## ADR Suggestion

ðŸ“‹ **Architectural decision detected**:
- **Decision**: Next.js App Router with route groups for auth vs. protected routes
- **Decision**: Better Auth with JWT Plugin for authentication
- **Decision**: Custom API client with automatic Bearer token injection
- **Decision**: Optimistic UI updates with useOptimistic hook

**Document reasoning and tradeoffs?** Run `/sp.adr frontend-architecture-decisions`

---

## References

- Feature Spec: [specs/ui/frontend-core.md](frontend-core.md)
- Constitution: [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
- Research: [plan/research.md](plan/research.md)
- Data Model: [plan/data-model.md](plan/data-model.md)
- Quickstart: [plan/quickstart.md](plan/quickstart.md)
- API Contract: [plan/contracts/api-client.ts](plan/contracts/api-client.ts)
- Auth Contract: [plan/contracts/auth-client.ts](plan/contracts/auth-client.ts)

---

**Plan Status**: âœ… COMPLETE - Ready for `/sp.tasks` command
**Branch**: `002-frontend-ui-core`
**Date**: 2025-12-23
